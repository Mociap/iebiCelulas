<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios - Igreja Evangélica Batista Itapevi</title>
    <link rel="shortcut icon" href="./3.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <a href="index.html" class="back-button">
        <i class="fas fa-arrow-left"></i>
    </a>
    <div class="user-info">
        <p><strong>Nome:</strong> <span id="userName"></span></p>
        <p><strong>Email:</strong> <span id="userEmail"></span></p>
        <p><strong>Função:</strong> <span id="userFuncao"></span></p>  
        <p><a href="#" id="logoutLink" class="logout-link">Sair</a></p>
    </div>
    <div class="header">
        <img src="./LogoBranco.png" alt="Logo da Igreja Evangélica Batista Itapevi">
    </div>
    <div class="container">
        <div class="card-container">
            <a href="frmOrganograma.html" class="card">
                <i class="fas fa-sitemap card-icon"></i>
                <h2>Organograma das Células</h2>
                <p>Visualize a estrutura hierárquica das células da igreja.</p>
                <div class="btn-primary">Acessar</div>
            </a>
            <a href="frmDashboard.html" class="card">
                <i class="fas fa-chart-line card-icon"></i>
                <h2>Indicadores</h2>
                <p>Visualize os principais indicadores das células.</p>
                <div class="btn-primary">Acessar</div>
            </a>
            <a href="relResumoMesCelula.html" class="card" >
                <i class="fas fa-chart-bar card-icon"></i>
                <h2>Resumo Mensal</h2>
                <p>Visualize um resumo das atividades e dados do mês.</p>
                <div class="btn-primary">Acessar</div>
            </a>
            <a href="relMembros.html" class="card">
                <i class="fas fa-users card-icon"></i>
                <h2>Relatório de Membros</h2>
                <p>Acesse informações detalhadas sobre os membros da igreja.</p>
                <div class="btn-primary">Acessar</div>
            </a>
            <a href="resumoreuniao.html" class="card">
                <i class="fas fa-calendar-alt card-icon"></i>
                <h2>Dados das Reuniões</h2>
                <p>Acesse os dados registrados das reuniões semanais.</p>
                <div class="btn-primary">Acessar</div>
            </a>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-auth.js"></script>
    <script>
        var configuracaoFirebase = {
            apiKey: "AIzaSyCEqseDS-_OSmdfGf-NNflAJnS_AT5i1-U",
            authDomain: "dbiebi.firebaseapp.com",
            databaseURL: "https://dbiebi-default-rtdb.firebaseio.com",
            projectId: "dbiebi",
            storageBucket: "dbiebi.appspot.com",
            messagingSenderId: "1068164821081",
            appId: "1:1068164821081:web:2d3e0030d5311d94f30148"
        };
        firebase.initializeApp(configuracaoFirebase);
        var bancoDeDados = firebase.firestore();

        function verificarTempoSessao() {
            const tempoLogin = localStorage.getItem('tempoLogin');
            const tempoAtual = new Date().getTime();
            const tempoLimite = 30 * 60 * 1000; // 30 minutos

            if (tempoAtual - tempoLogin > tempoLimite) {
                realizarLogout();
            }
        }

        function realizarLogout() {
            firebase.auth().signOut().then(() => {
                localStorage.clear();
                window.location.href = 'formlogin.html';
            }).catch((erro) => {
                console.error('Erro ao fazer logout:', erro);
            });
        }

        setInterval(verificarTempoSessao, 60000); // Verifica a cada minuto
        verificarTempoSessao(); // Verifica imediatamente ao carregar a página
     
        async function carregarDadosAdicionais() {
            const nomeUsuario = localStorage.getItem('nomeUsuario');
            console.log("Nome do usuário:", nomeUsuario);
            if (nomeUsuario) {
                try {
                    const queryUsuario = await bancoDeDados.collection("usuarios").where("nome", "==", nomeUsuario).get();
                    if (!queryUsuario.empty) {
                        const dadosUsuario = queryUsuario.docs[0].data();
                        const funcaoUsuario = dadosUsuario.funcao || '';
                        localStorage.setItem('funcaoUsuario', funcaoUsuario);
                    }

                    const queryMembro = await bancoDeDados.collection("membros").where("nome", "==", nomeUsuario).get();
                    if (!queryMembro.empty) {
                        const dadosMembro = queryMembro.docs[0].data();
                        localStorage.setItem('celulaUsuario', dadosMembro.nomedacelula || '');

                        const queryEstrutura = await bancoDeDados.collection("estruturacelula").where("nomecelula", "==", dadosMembro.nomedacelula).get();
                        if (!queryEstrutura.empty) {
                            const dadosEstrutura = queryEstrutura.docs[0].data();
                            localStorage.setItem('liderUsuario', dadosEstrutura.conclider || '');
                            localStorage.setItem('supervisorUsuario', dadosEstrutura.supervisor || '');
                            localStorage.setItem('redeUsuario', dadosEstrutura.rede || '');
                        }
                    }
                } catch (erro) {
                    console.error("Erro ao carregar dados adicionais:", erro);
                }
            }
        }

        // Função para associar, rede, supervisor e lider do usuário
        async function encontrarRedesDoUsuario() {
            try {
                const nomeUsuario = localStorage.getItem('nomeUsuario');
                console.log(`Iniciando a busca pelas redes, supervisores e líderes do usuário: ${nomeUsuario}`);
                console.log("Nome do usuário:", nomeUsuario);

                const dadosUsuario = {};

                const querySnapshot = await bancoDeDados.collection('estruturacelula')
                    .where('coordenador', '==', nomeUsuario)
                    .get();

                querySnapshot.forEach((doc) => {
                    const dados = doc.data();
                    const rede = dados.rede;
                    const supervisor = dados.supervisor;
                    const lider = dados.conclider;

                    if (!dadosUsuario[nomeUsuario]) {
                        dadosUsuario[nomeUsuario] = [];
                    }

                    dadosUsuario[nomeUsuario].push({ rede, supervisor, lider });

                    console.log(`Dados encontrados para o coordenador ${nomeUsuario}:`, { rede, supervisor, lider });
                });

                const camposLider = ['supervisor1', 'supervisor2', 'nomelider1', 'nomelider2', 'nomelider3'];

                for (const campo of camposLider) {
                    console.log(`Buscando redes, supervisores e líderes para o campo ${campo}`);

                    const querySnapshot = await bancoDeDados.collection('estruturacelula')
                        .where(campo, '==', nomeUsuario)
                        .get();

                    querySnapshot.forEach((doc) => {
                        const dados = doc.data();
                        const rede = dados.rede;
                        const supervisor = dados.supervisor;
                        const lider = dados.conclider;

                        if (!dadosUsuario[nomeUsuario]) {
                            dadosUsuario[nomeUsuario] = [];
                        }

                        dadosUsuario[nomeUsuario].push({ rede, supervisor, lider });

                        console.log(`Dados encontrados para o campo ${campo} e usuário ${nomeUsuario}:`, { rede, supervisor, lider });
                    });
                }

                console.log(`Dados encontrados para o usuário ${nomeUsuario}:`, dadosUsuario);

                // Armazenar os dados no localStorage
                localStorage.setItem('dadosUsuario', JSON.stringify(dadosUsuario));

                return dadosUsuario;
            } catch (error) {
                console.error('Erro ao encontrar as redes, supervisores e líderes do usuário:', error);
                return {};
            }
        }

        async function ajustafuncaoUsuario() {
            try {
                const nomeUsuario = localStorage.getItem('nomeUsuario');
                const funcao = localStorage.getItem('funcaoUsuario');

                let funcaoUsuario = 'Membro';

                if (funcao === 'ADMIN') {
                    funcaoUsuario = 'ADMIN';
                } else {
                    const querySnapshot = await bancoDeDados.collection('estruturacelula')
                        .where('pastor1', '==', nomeUsuario)
                        .get();

                    if (!querySnapshot.empty) {
                        funcaoUsuario = 'Pastor';
                    } else {
                        const querySnapshot = await bancoDeDados.collection('estruturacelula')
                            .where('pastor2', '==', nomeUsuario)
                            .get();

                        if (!querySnapshot.empty) {
                            funcaoUsuario = 'Pastor';
                        } else {
                            const querySnapshot = await bancoDeDados.collection('estruturacelula')
                                .where('coordenador1', '==', nomeUsuario)
                                .get();

                            if (!querySnapshot.empty) {
                                funcaoUsuario = 'Coordenador';
                            } else {
                                const querySnapshot = await bancoDeDados.collection('estruturacelula')
                                    .where('coordenador2', '==', nomeUsuario)
                                    .get();

                                if (!querySnapshot.empty) {
                                    funcaoUsuario = 'Coordenador';
                                } else {
                                    const querySnapshot = await bancoDeDados.collection('estruturacelula')
                                        .where('supervisor1', '==', nomeUsuario)
                                        .get();

                                    if (!querySnapshot.empty) {
                                        funcaoUsuario = 'Supervisor';
                                    } else {
                                        const querySnapshot = await bancoDeDados.collection('estruturacelula')
                                            .where('supervisor2', '==', nomeUsuario)
                                            .get();

                                        if (!querySnapshot.empty) {
                                            funcaoUsuario = 'Supervisor';
                                        } else {
                                            const querySnapshot = await bancoDeDados.collection('estruturacelula')
                                                .where('nomelider1', '==', nomeUsuario)
                                                .get();

                                            if (!querySnapshot.empty) {
                                                funcaoUsuario = 'Líder';
                                            } else {
                                                const querySnapshot = await bancoDeDados.collection('estruturacelula')
                                                    .where('nomelider2', '==', nomeUsuario)
                                                    .get();

                                                if (!querySnapshot.empty) {
                                                    funcaoUsuario = 'Líder';
                                                } else {
                                                    const querySnapshot = await bancoDeDados.collection('estruturacelula')
                                                        .where('nomelider3', '==', nomeUsuario)
                                                        .get();

                                                    if (!querySnapshot.empty) {
                                                        funcaoUsuario = 'Líder';
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                console.log(`Função do usuário ${nomeUsuario}:`, funcaoUsuario);
                return { funcao: funcaoUsuario };                
            } catch (error) {
                console.error('Erro ao encontrar a função do usuário:', error);
                return { funcao: 'Membro' };
            }
        }

        // Exemplo de uso
        const nomeUsuario = 'Nome do Usuário';
        encontrarRedesDoUsuario(nomeUsuario)
            .then((redes) => {
                console.log(`Redes do usuário ${nomeUsuario}:`, redes);
                // Faça algo com as redes encontradas, como exibi-las na página
            })
            .catch((error) => {
                console.error('Erro ao encontrar as redes do usuário:', error);
            });

            // Exemplo de uso
            ajustafuncaoUsuario()
                .then((resultado) => {
                    const funcaoUsuario = resultado.funcao;
                    localStorage.setItem('funcaoUsuario', funcaoUsuario);
                    console.log("Função do usuário:", funcaoUsuario);
                    // Faça algo com a função do usuário, como exibi-la na página
                })
                .catch((error) => {
                    console.error('Erro ao encontrar a função do usuário:', error);
                })
                
        window.onload = async function() {
            await carregarDadosAdicionais();
            await ajustafuncaoUsuario();

            const userName = localStorage.getItem('nomeUsuario');
            const userEmail = localStorage.getItem('emailUsuario');
            const userFuncao = localStorage.getItem('funcaoUsuario');
                                
            document.getElementById('userName').textContent = userName || 'Não disponível';
            document.getElementById('userEmail').textContent = userEmail || 'Não disponível';
            document.getElementById('userFuncao').textContent = userFuncao || 'Não disponível';
             
            // Obtém todas as chaves do localStorage
            const chaves = Object.keys(localStorage);

// Verifica se há chaves no localStorage
if (chaves.length > 0) {
    console.log("Dados armazenados no localStorage:");

    // Percorre as chaves e exibe os valores correspondentes
    chaves.forEach(function(chave) {
        const valor = localStorage.getItem(chave);
        console.log(`${chave}: ${valor}`);
    });
} else {
    console.log("Não há dados armazenados no localStorage.");
}

            document.getElementById('logoutLink').addEventListener('click', function(e) {
                e.preventDefault();
                realizarLogout();
            });
        };
    </script>
</body>
</html>