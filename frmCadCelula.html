<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Cadastro de Células</title>
    <link rel="shortcut icon" href="./3.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/botao-voltar.css">

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            margin: 0;
            padding: 0px;
        }

        .container {
            max-width: 500px;
            margin: 20px auto;
            background-color: #2c2c2c;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .header {
            background-color: #2c2c2c;
            padding: 20px 0;
            text-align: center;
            position: relative;
            z-index: 1000;
        }

        .header img {
            max-width: 180px;
        }

        .divider {
            width: 75%;
            height: 2px;
            background-color: #3498db;
            margin: 30px auto;
        }

        .btn-primary {
            background-color: #3498db;
            border-color: #3498db;
            transition: background-color 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }

        .form-control {
            background-color: #3c3c3c;
            border: none;
            color: #ffffff;
        }

        .form-control:focus {
            background-color: #4c4c4c;
            color: #ffffff;
            box-shadow: none;
        }

        label {
            color: #cfcccc;
            font-weight: bold;
        }

        .form-control:read-only {
            background-color: #3c3c3c;
            color: #ffffff;
            opacity: 1;
        }

        .form-control:read-only:focus {
            background-color: #4c4c4c;
            color: #ffffff;
            box-shadow: none;
        }
    </style>
</head>

<body>
    <a href="frmEstruturaCelula.html" class="back-button">
        <i class="fas fa-arrow-left"></i>
    </a>
    <div class="header">
        <img src="./LogoBranco.png" alt="Logo da Igreja Evangélica Batista Itapevi">
    </div>
    <div class="container">
        <h2 class="text-center mb-4 font-weight-bold">Cadastro de Células</h2>
        <div class="divider"></div>
        <form id="cellForm">
            <div class="form-group">
                <label for="nomeigreja">Nome da Igreja</label>
                <select class="form-control" id="nomeigreja" required>
                    <option value="">Selecione uma igreja</option>
                </select>
            </div>
            <div class="form-group">
                <label for="rede">Rede</label>
                <select class="form-control" id="rede" required onchange="alterarCorRede(this.value)">
                    <option value="">Selecione uma rede</option>
                    <option value="AMARELA">AMARELA</option>
                    <option value="AZUL">AZUL</option>
                    <option value="TEEN">TEEN</option>
                    <option value="LARANJA">LARANJA</option>
                    <option value="VERMELHA">VERMELHA</option>
                    <option value="BLACK">BLACK</option>
                    <option value="VERDE">VERDE</option>
                </select>
            </div>
            <div class="form-group">
                <label for="Pastor">Pastor</label>
                <input type="text" class="form-control" id="Pastor" readonly>
            </div>
            <div class="form-group">
                <label for="pastor1">Pastor 1</label>
                <input type="text" class="form-control" id="pastor1"
                    onkeyup="this.value = this.value.toUpperCase(); buscarNomes(this, 'listaPastor1')">
                <div id="listaPastor1" class="lista-nomes"></div>
            </div>
            <div class="form-group">
                <label for="pastor2">Pastor 2</label>
                <input type="text" class="form-control" id="pastor2"
                    onkeyup="this.value = this.value.toUpperCase(); buscarNomes(this, 'listaPastor2')">
                <div id="listaPastor2" class="lista-nomes"></div>
            </div>
            <div class="form-group">
                <label for="coordenador">Coordenador</label>
                <input type="text" class="form-control" id="coordenador">
            </div>
            <div class="form-group">
                <label for="coordenador1">Coordenador 1</label>
                <input type="text" class="form-control" id="coordenador1"
                    onkeyup="this.value = this.value.toUpperCase(); buscarNomes(this, 'listaCoordenador1')">
                <div id="listaCoordenador1" class="lista-nomes"></div>
            </div>
            <div class="form-group">
                <label for="coordenador2">Coordenador 2</label>
                <input type="text" class="form-control" id="coordenador2"
                    onkeyup="this.value = this.value.toUpperCase(); buscarNomes(this, 'listaCoordenador2')">
                <div id="listaCoordenador2" class="lista-nomes"></div>
            </div>
            <div class="form-group">
                <label for="supervisor">Supervisor</label>
                <input type="text" class="form-control" id="supervisor">
            </div>
            <div class="form-group">
                <label for="supervisor1">Supervisor 1</label>
                <input type="text" class="form-control" id="supervisor1"
                    oninput="this.value = this.value.toUpperCase(); buscarNomes(this, 'listaSupervisor1')">
                <div id="listaSupervisor1" class="lista-nomes"></div>
            </div>
            <div class="form-group">
                <label for="supervisor2">Supervisor 2</label>
                <input type="text" class="form-control" id="supervisor2"
                    oninput="this.value = this.value.toUpperCase(); buscarNomes(this, 'listaSupervisor2')">
                <div id="listaSupervisor2" class="lista-nomes"></div>
            </div>
            <div class="form-group">
                <label for="conclider">Líder</label>
                <input type="text" class="form-control" id="conclider">
            </div>
            <div class="form-group">
                <label for="nomelider1">Nome do Líder 1</label>
                <input type="text" class="form-control" id="nomelider1"
                    onkeyup="this.value = this.value.toUpperCase(); buscarNomes(this, 'listaLider1')">
                <div id="listaLider1" class="lista-nomes"></div>
            </div>
            <div class="form-group">
                <label for="nomelider2">Nome do Líder 2</label>
                <input type="text" class="form-control" id="nomelider2"
                    onkeyup="this.value = this.value.toUpperCase(); buscarNomes(this, 'listaLider2')">
                <div id="listaLider2" class="lista-nomes"></div>
            </div>
            <div class="form-group">
                <label for="nomelider3">Nome do Líder 3</label>
                <input type="text" class="form-control" id="nomelider3"
                    onkeyup="this.value = this.value.toUpperCase(); buscarNomes(this, 'listaLider3')">
                <div id="listaLider3" class="lista-nomes"></div>
            </div>
            <div class="form-group">
                <label for="nomecelula">Nome da Célula</label>
                <input type="text" class="form-control" id="nomecelula" required
                    onkeyup="this.value = this.value.toUpperCase();">
            </div>
            <div class="form-group">
                <label for="diaSemana">Dia da Semana</label>
                <select class="form-control" id="diaSemana" required>
                    <option value="">Selecione o dia</option>
                    <option value="DOMINGO">DOMINGO</option>
                    <option value="SEGUNDA">SEGUNDA-FEIRA</option>
                    <option value="TERCA">TERÇA-FEIRA</option>
                    <option value="QUARTA">QUARTA-FEIRA</option>
                    <option value="QUINTA">QUINTA-FEIRA</option>
                    <option value="SEXTA">SEXTA-FEIRA</option>
                    <option value="SABADO">SÁBADO</option>
                </select>
            </div>
            <div class="form-group">
                <label for="horario">Horário</label>
                <input type="time" class="form-control" id="horario" required>
            </div>
            <div class="form-group">
                <label for="local">Local</label>
                <input type="text" class="form-control" id="local" required
                    onkeyup="this.value = this.value.toUpperCase();">
            </div>
            <div class="btn-group btn-block" role="group">
                <button type="submit" class="btn btn-primary" id="cadastrarBtn">Cadastrar</button>
                <button type="button" class="btn btn-warning" id="editarBtn">Editar</button>
                <button type="button" class="btn btn-danger" id="excluirBtn">Excluir</button>
            </div>
        </form>
    </div>

    <!-- Importar Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        // Configuração do Firebase
        var configuracaoFirebase = {
            apiKey: "AIzaSyCEqseDS-_OSmdfGf-NNflAJnS_AT5i1-U",
            authDomain: "dbiebi.firebaseapp.com",
            databaseURL: "https://dbiebi-default-rtdb.firebaseio.com",
            projectId: "dbiebi",
            storageBucket: "dbiebi.appspot.com",
            messagingSenderId: "1068164821081",
            appId: "1:1068164821081:web:2d3e0030d5311d94f30148"
        };
        firebase.initializeApp(configuracaoFirebase);
        var bancoDeDados = firebase.firestore();

        // Referência ao formulário
        var formulario = document.getElementById('cellForm');

        function obterParametroURL(nome) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(nome);
        }

        function preencherFormulario(data) {
            document.getElementById('nomeigreja').value = data.nomeigreja;
            document.getElementById('rede').value = data.rede;
            document.getElementById('Pastor').value = data.Pastor;
            document.getElementById('pastor1').value = data.pastor1;
            document.getElementById('pastor2').value = data.pastor2;
            document.getElementById('coordenador').value = data.coordenador;
            document.getElementById('coordenador1').value = data.coordenador1;
            document.getElementById('coordenador2').value = data.coordenador2;
            document.getElementById('supervisor').value = data.supervisor;
            document.getElementById('supervisor1').value = data.supervisor1;
            document.getElementById('supervisor2').value = data.supervisor2;
            document.getElementById('conclider').value = data.conclider;
            document.getElementById('nomelider1').value = data.nomelider1;
            document.getElementById('nomelider2').value = data.nomelider2;
            document.getElementById('nomelider3').value = data.nomelider3;
            document.getElementById('nomecelula').value = data.nomecelula;
            document.getElementById('diaSemana').value = data.diaSemana || '';
            document.getElementById('horario').value = data.horario || '';
            document.getElementById('local').value = data.local || '';

            alterarCorRede(data.rede);
        }

        function carregarDadosCelula() {
            const lider = obterParametroURL('lider');
            const nomecelula = obterParametroURL('nomecelula');

            if (lider && nomecelula) {
                bancoDeDados.collection('estruturacelula')
                    .where('conclider', '==', lider)
                    .where('nomecelula', '==', nomecelula)
                    .limit(1)
                    .get()
                    .then((querySnapshot) => {
                        if (!querySnapshot.empty) {
                            const doc = querySnapshot.docs[0];
                            const data = doc.data();
                            preencherFormulario(data);
                        } else {
                            console.log('Nenhum documento encontrado');
                        }
                    })
                    .catch((error) => {
                        console.error('Erro ao carregar dados:', error);
                    });
            }
        }

        // Preencher o dropdown de igrejas
        bancoDeDados.collection('igreja').get().then((querySnapshot) => {
            const selectIgreja = document.getElementById('nomeigreja');
            querySnapshot.forEach((doc) => {
                const option = document.createElement('option');
                option.value = doc.data().nomeigreja;
                option.text = doc.data().nomeigreja;
                selectIgreja.add(option);
            });
        });

        let ultimaBusca = '';
        let timeoutId;

        function debounce(func, delay) {
            return function () {
                const context = this;
                const args = arguments;
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(context, args), delay);
            };
        }
        function buscarNomes(input, listaId) {
            const valor = input.value.toUpperCase();
            const lista = document.getElementById(listaId);

            if (valor === ultimaBusca) return;
            ultimaBusca = valor;

            lista.innerHTML = '';
            console.log(`Buscando nomes para: ${valor}`);

            if (valor.length < 2) return;

            const nomesEncontrados = new Set();

            bancoDeDados.collection('membros')
                .where('nome', '>=', valor)
                .where('nome', '<=', valor + '\uf8ff')
                .limit(5)
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const nome = doc.data().nome;
                        if (!nomesEncontrados.has(nome)) {
                            nomesEncontrados.add(nome);
                            const div = document.createElement('div');
                            div.textContent = nome;
                            div.onclick = function () {
                                input.value = nome;
                                lista.innerHTML = '';
                                if (input.id === 'pastor1' || input.id === 'pastor2') {
                                    atualizarCampoPastor();
                                } else if (input.id === 'coordenador1' || input.id === 'coordenador2') {
                                    atualizarCampoCoordenador();
                                } else if (input.id === 'supervisor1' || input.id === 'supervisor2') {
                                    atualizarCampoSupervisor();
                                } else if (input.id === 'nomelider1' || input.id === 'nomelider2' || input.id === 'nomelider3') {
                                    atualizarCampoLider();
                                }
                            };
                            lista.appendChild(div);
                        }
                    });
                });
        }
        // Use a função debounce ao adicionar o event listener
        document.getElementById('nomelider1').addEventListener('input', debounce(function () {
            buscarNomes(this, 'listaLider1');
        }, 300));

        // Repita para outros campos de entrada              
        // Adicionar evento de envio do formulário
        formulario.addEventListener('submit', function (e) {
            e.preventDefault();
            console.log("Formulário submetido");

            // Obter valores dos campos
            var nomeigreja = document.getElementById('nomeigreja').value.trim().toUpperCase();
            var rede = document.getElementById('rede').value.trim().toUpperCase();
            var Pastor = document.getElementById('Pastor').value.trim().toUpperCase();
            var pastor1 = document.getElementById('pastor1').value.trim().toUpperCase();
            var pastor2 = document.getElementById('pastor2').value.trim().toUpperCase();
            var coordenador = document.getElementById('coordenador').value.trim().toUpperCase();
            var coordenador1 = document.getElementById('coordenador1').value.trim().toUpperCase();
            var coordenador2 = document.getElementById('coordenador2').value.trim().toUpperCase();
            var supervisor = document.getElementById('supervisor').value.trim().toUpperCase();
            var supervisor1 = document.getElementById('supervisor1').value.trim().toUpperCase();
            var supervisor2 = document.getElementById('supervisor2').value.trim().toUpperCase();
            var conclider = document.getElementById('conclider').value.trim().toUpperCase();
            var nomelider1 = document.getElementById('nomelider1').value.trim().toUpperCase();
            var nomelider2 = document.getElementById('nomelider2').value.trim().toUpperCase();
            var nomelider3 = document.getElementById('nomelider3').value.trim().toUpperCase();
            var nomecelula = document.getElementById('nomecelula').value.trim().toUpperCase();
            var diaSemana = document.getElementById('diaSemana').value.trim();
            var horario = document.getElementById('horario').value;
            var local = document.getElementById('local').value;

            // Adicionar dados ao Firestore
            bancoDeDados.collection('estruturacelula').add({
                nomeigreja: nomeigreja,
                rede: rede,
                Pastor: Pastor,
                pastor1: pastor1,
                pastor2: pastor2,
                coordenador: coordenador,
                coordenador1: coordenador1,
                coordenador2: coordenador2,
                supervisor: supervisor,
                supervisor1: supervisor1,
                supervisor2: supervisor2,
                conclider: conclider,
                nomelider1: nomelider1,
                nomelider2: nomelider2,
                nomelider3: nomelider3,
                nomecelula: nomecelula,
                diaSemana: diaSemana,
                horario: horario,
                local: local
            })
                .then(function () {
                    console.log("Célula cadastrada com sucesso");
                    window.location.href = 'agradecimento.html';
                })
                .catch(function (error) {
                    console.error("Erro ao cadastrar célula:", error);
                    alert('Erro ao cadastrar célula: ' + error.message);
                });
        });

        // Função para alterar a cor da caixa de acordo com a rede escolhida
        function alterarCorRede(rede) {
            var inputRede = document.getElementById('rede');
            var cores = {
                'AMARELA': '#FFFF00',
                'AZUL': '#0000FF',
                'TEEN': '#800080',
                'LARANJA': '#FFA500',
                'VERMELHA': '#FF0000',
                'BLACK': '#000000',
                'VERDE': '#008000'
            };

            var cor = cores[rede] || '#000000';
            inputRede.style.backgroundColor = cor;
            inputRede.style.color = (cor === '#000000' || cor === '#800080' || cor === '#0000FF') ? '#FFFFFF' : '#000000';
        }

        // Adicionar evento de mudança ao campo rede
        document.getElementById('rede').addEventListener('change', function () {
            alterarCorRede(this.value);
        });

        // Adicione esta função ao seu script existente
        function atualizarCampos() {
            atualizarCampoPastor();
            atualizarCampoCoordenador();
            atualizarCampoSupervisor();
            atualizarCampoLider();
        }

        function atualizarCampoPastor() {
            var pastor1 = document.getElementById('pastor1').value.trim();
            var pastor2 = document.getElementById('pastor2').value.trim();
            var campoPastor = document.getElementById('Pastor');

            var nomePastor1 = pastor1.split(' ')[0];
            var nomePastor2 = pastor2.split(' ')[0];

            if (nomePastor1 && nomePastor2) {
                campoPastor.value = nomePastor1.toUpperCase() + ' / ' + nomePastor2.toUpperCase();
            } else if (nomePastor1) {
                campoPastor.value = nomePastor1.toUpperCase();
            } else if (nomePastor2) {
                campoPastor.value = nomePastor2.toUpperCase();
            } else {
                campoPastor.value = '';
            }
        }

        function atualizarCampoCoordenador() {
            var coordenador1 = document.getElementById('coordenador1').value.trim();
            var coordenador2 = document.getElementById('coordenador2').value.trim();
            var campoCoordenador = document.getElementById('coordenador');

            var nomeCoordenador1 = coordenador1.split(' ')[0];
            var nomeCoordenador2 = coordenador2.split(' ')[0];

            if (nomeCoordenador1 && nomeCoordenador2) {
                campoCoordenador.value = nomeCoordenador1.toUpperCase() + ' / ' + nomeCoordenador2.toUpperCase();
            } else if (nomeCoordenador1) {
                campoCoordenador.value = nomeCoordenador1.toUpperCase();
            } else if (nomeCoordenador2) {
                campoCoordenador.value = nomeCoordenador2.toUpperCase();
            } else {
                campoCoordenador.value = '';
            }
        }

        function atualizarCampoSupervisor() {
            var supervisor1 = document.getElementById('supervisor1').value.trim();
            var supervisor2 = document.getElementById('supervisor2').value.trim();
            var campoSupervisor = document.getElementById('supervisor');

            var nomeSupervisor1 = supervisor1.split(' ')[0];
            var nomeSupervisor2 = supervisor2.split(' ')[0];

            if (nomeSupervisor1 && nomeSupervisor2) {
                campoSupervisor.value = nomeSupervisor1.toUpperCase() + ' / ' + nomeSupervisor2.toUpperCase();
            } else if (nomeSupervisor1) {
                campoSupervisor.value = nomeSupervisor1.toUpperCase();
            } else if (nomeSupervisor2) {
                campoSupervisor.value = nomeSupervisor2.toUpperCase();
            } else {
                campoSupervisor.value = '';
            }
        }

        function atualizarCampoLider() {
            var lider1 = document.getElementById('nomelider1').value.trim();
            var lider2 = document.getElementById('nomelider2').value.trim();
            var lider3 = document.getElementById('nomelider3').value.trim();
            var campoLider = document.getElementById('conclider');

            var nomeLider1 = lider1.split(' ')[0];
            var nomeLider2 = lider2.split(' ')[0];
            var nomeLider3 = lider3.split(' ')[0];

            var lideres = [nomeLider1, nomeLider2, nomeLider3].filter(Boolean);

            if (lideres.length > 0) {
                campoLider.value = lideres.map(nome => nome.toUpperCase()).join(' / ');
            } else {
                campoLider.value = '';
            }
        }

        // Adicione estes event listeners
        document.getElementById('pastor1').addEventListener('input', atualizarCampos);
        document.getElementById('pastor2').addEventListener('input', atualizarCampos);
        document.getElementById('coordenador1').addEventListener('input', atualizarCampos);
        document.getElementById('coordenador2').addEventListener('input', atualizarCampos);
        document.getElementById('supervisor1').addEventListener('input', atualizarCampos);
        document.getElementById('supervisor2').addEventListener('input', atualizarCampos);
        document.getElementById('nomelider1').addEventListener('input', atualizarCampos);
        document.getElementById('nomelider2').addEventListener('input', atualizarCampos);
        document.getElementById('nomelider3').addEventListener('input', atualizarCampos);

        document.addEventListener('DOMContentLoaded', function () {
            carregarDadosCelula();
            const editarBtn = document.getElementById('editarBtn');
            const excluirBtn = document.getElementById('excluirBtn');

            editarBtn.addEventListener('click', function () {
                const lider = obterParametroURL('lider');
                const nomecelula = obterParametroURL('nomecelula');

                if (lider && nomecelula) {
                    bancoDeDados.collection('estruturacelula')
                        .where('conclider', '==', lider)
                        .where('nomecelula', '==', nomecelula)
                        .limit(1)
                        .get()
                        .then((querySnapshot) => {
                            if (!querySnapshot.empty) {
                                const doc = querySnapshot.docs[0];
                                const data = obterDadosFormulario();
                                doc.ref.update(data)
                                    .then(() => {
                                        alert('Documento atualizado com sucesso!');
                                        window.location.href = 'frmEstruturaCelula.html';
                                    })
                                    .catch((error) => {
                                        console.error('Erro ao atualizar documento:', error);
                                        alert('Erro ao atualizar documento: ' + error.message);
                                    });
                            }
                        });
                }
            });

            excluirBtn.addEventListener('click', function () {
                if (confirm('Tem certeza que deseja excluir esta célula?')) {
                    const lider = obterParametroURL('lider');
                    const nomecelula = obterParametroURL('nomecelula');

                    if (lider && nomecelula) {
                        bancoDeDados.collection('estruturacelula')
                            .where('conclider', '==', lider)
                            .where('nomecelula', '==', nomecelula)
                            .limit(1)
                            .get()
                            .then((querySnapshot) => {
                                if (!querySnapshot.empty) {
                                    const doc = querySnapshot.docs[0];
                                    doc.ref.delete()
                                        .then(() => {
                                            alert('Documento excluído com sucesso!');
                                            window.location.href = 'frmEstruturaCelula.html';
                                        })
                                        .catch((error) => {
                                            console.error('Erro ao excluir documento:', error);
                                            alert('Erro ao excluir documento: ' + error.message);
                                        });
                                }
                            });
                    }
                }
            });

            function obterDadosFormulario() {
                return {
                    nomeigreja: document.getElementById('nomeigreja').value.trim().toUpperCase(),
                    rede: document.getElementById('rede').value.trim().toUpperCase(),
                    Pastor: document.getElementById('Pastor').value.trim().toUpperCase(),
                    pastor1: document.getElementById('pastor1').value.trim().toUpperCase(),
                    pastor2: document.getElementById('pastor2').value.trim().toUpperCase(),
                    coordenador: document.getElementById('coordenador').value.trim().toUpperCase(),
                    coordenador1: document.getElementById('coordenador1').value.trim().toUpperCase(),
                    coordenador2: document.getElementById('coordenador2').value.trim().toUpperCase(),
                    supervisor: document.getElementById('supervisor').value.trim().toUpperCase(),
                    supervisor1: document.getElementById('supervisor1').value.trim().toUpperCase(),
                    supervisor2: document.getElementById('supervisor2').value.trim().toUpperCase(),
                    conclider: document.getElementById('conclider').value.trim().toUpperCase(),
                    nomelider1: document.getElementById('nomelider1').value.trim().toUpperCase(),
                    nomelider2: document.getElementById('nomelider2').value.trim().toUpperCase(),
                    nomelider3: document.getElementById('nomelider3').value.trim().toUpperCase(),
                    nomecelula: document.getElementById('nomecelula').value.trim().toUpperCase(),
                    diaSemana: document.getElementById('diaSemana').value.trim(),
                    horario: document.getElementById('horario').value,
                    local: document.getElementById('local').value
                };
            }
        });
    </script>
</body>

</html>