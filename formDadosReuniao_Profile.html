<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dados da Reunião</title>
  <link rel="shortcut icon" href="./3.ico" type="image/x-icon" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>

  <style>
    body {
      font-family: "Nunito", sans-serif;
      background-color: #1a1a1a;
      color: #ffffff;
      margin: 0;
      padding: 0;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"]:disabled {
      background-color: #3c3c3c !important;
      opacity: 0.7;
      cursor: not-allowed;
    }

    input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    .container {
      max-width: 500px;
      margin: 20px auto;
      background-color: #2c2c2c;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    }

    .header {
      background-color: #2c2c2c;
      padding: 20px 0;
      text-align: center;
      position: relative;
      z-index: 1000;
    }

    .header img {
      max-width: 180px;
    }

    .divider {
      width: 75%;
      height: 2px;
      background-color: #9919cc;
      margin: 30px auto;
    }

    .btn-primary {
      background-color: #9919cc;
      border-color: #9919cc;
      transition: background-color 0.3s ease;
    }

    .btn-primary:hover {
      background-color: #9919cc;
      border-color: #9919cc;
    }

    .form-control {
      background-color: #3c3c3c !important;
      border: none;
      color: #ffffff !important;
    }

    .form-control:focus {
      background-color: #4c4c4c !important;
      color: #ffffff !important;
      box-shadow: none;
    }

    .form-control:disabled {
      background-color: #3c3c3c !important;
      opacity: 0.7;
      cursor: not-allowed;
    }

    select.form-control option {
      background-color: #2c2c2c;
      color: #ffffff;
    }

    select.form-control:focus option:hover,
    select.form-control option:hover,
    select.form-control option:checked {
      background-color: #4c4c4c;
      color: #ffffff;
    }

    select.form-control optgroup {
      background-color: #2c2c2c;
      color: #ffffff;
    }

    label {
      color: #cfcccc;
      /* Cor azul clara, consistente com a paleta existente */
      font-weight: bold;
    }

    .form-group-switch {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
      margin-left: 10px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: #9919cc;
    }

    input:checked+.slider:before {
      transform: translateX(26px);
    }

    #data {
      background-color: #3c3c3c;
      cursor: pointer;
      color: #ffffff;
    }

    #data:focus {
      box-shadow: none;
      border-color: #9919cc;
    }

    .back-button {
      position: fixed;
      top: 20px;
      left: 20px;
      background-color: #9919cc;
      color: #ffffff;
      padding: 10px;
      border-radius: 50%;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      transition: all 0.3s ease;
      z-index: 1001;
    }

    .back-button:hover {
      background-color: #9919cc;
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .back-button i {
      margin-right: 0;
    }

    .back-button span {
      font-weight: 600;
    }

    .form-control[readonly] {
      background-color: #3c3c3c;
      opacity: 0.7;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <a href="index.html" class="back-button">
    <i class="fas fa-arrow-left"></i>
  </a>
  <div class="header">
    <img src="./LogoBranco.png" alt="Logo da Igreja Evangélica Batista Itapevi" />
  </div>

  <div class="container">
    <h2 class="text-center mb-4">Dados da Reunião</h2>
    <div class="divider"></div>
    <form id="reuniaoForm">
      <div class="form-group-switch reuniao-realizada-switch">
        <label class="switch-label" for="reuniaoRealizada">Reunião Realizada</label>
        <label class="switch">
          <input type="checkbox" id="reuniaoRealizada" checked />
          <span class="slider round"></span>
        </label>
      </div>

      <div id="camposReuniao">
        <div class="form-group">
          <label for="data">Data da Reunião</label>
          <input type="text" class="form-control" id="data" placeholder="Selecione a data..." required readonly />
        </div>

        <div class="form-group" style="display: none">
          <label for="ano">Ano</label>
          <input type="number" class="form-control" id="ano" readonly />
        </div>

        <div class="form-group" style="display: none">
          <label for="mesAno">Mês/Ano</label>
          <input type="text" class="form-control" id="mesAno" readonly />
        </div>

        <div class="form-group">
          <label for="igreja">Igreja</label>
          <input type="text" class="form-control" id="igreja" readonly>
      </div>
      
      <div class="form-group">
          <label for="supervisor">Supervisor</label>
          <input type="text" class="form-control" id="supervisor" readonly>
      </div>
      
      <div class="form-group">
          <label for="lider">Líder</label>
          <input type="text" class="form-control" id="lider" readonly>
      </div>

        <div class="form-group">
          <label for="celula">Célula</label>
          <input type="text" class="form-control" id="celula" readonly />
        </div>

        <div class="form-group campo-reuniao">
          <label>Presença</label>
          <div id="presencaContainer"></div>
        </div>

        <div class="form-group campo-reuniao">
          <label for="qtdVisitantes">Quantidade de Visitantes</label>
          <input type="number" class="form-control" id="qtdVisitantes" required />
        </div>

        <div class="form-group campo-reuniao">
          <label for="oferta">Oferta</label>
          <input type="text" class="form-control" id="oferta" required />
        </div>

        <div class="form-group campo-reuniao">
          <label>Colheita do Amor</label>
          <select class="form-control" id="tipoAlimento" required>
            <option value="" disabled selected>
              Selecione um alimento.
            </option>
          </select>
        </div>

        <div class="form-group campo-reuniao">
          <label>Quant Unidades</label>
          <input type="number" class="form-control" id="qtdAlimento" placeholder="Quantidade" min="1" step="1"
            onkeypress="return event.charCode >= 48 && event.charCode <= 57" required  />
        </div>

      </div>

      <div class="form-group campo-reuniao">
        <label for="qtdMembros">Quantidade de Membros</label>
        <input type="number" class="form-control" id="qtdMembros" readonly />
      </div>

      <div class="form-group campo-reuniao">
        <label for="membroPresentes">Membros Presentes</label>
        <input type="number" class="form-control" id="membroPresentes" readonly />
      </div>

      <div class="row">
        <div class="col-md-6">
            <button type="button" class="btn btn-primary btn-block" id="btnAtualizar">
                <i class="fas fa-sync-alt mr-2"></i>Atualizar
            </button>
        </div>
        <div class="col-md-6">
            <button type="button" class="btn btn-danger btn-block" id="btnExcluir">
                <i class="fas fa-trash-alt mr-2"></i>Excluir
            </button>
        </div>
    </div>
    </form>
  </div>
  </div>

  <!-- Importar Firebase -->
  <script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-firestore.js"></script>

  <script>
    // Configuração do Firebase
    var configuracaoFirebase = {
      apiKey: "AIzaSyCEqseDS-_OSmdfGf-NNflAJnS_AT5i1-U",
      authDomain: "dbiebi.firebaseapp.com",
      databaseURL: "https://dbiebi-default-rtdb.firebaseio.com",
      projectId: "dbiebi",
      storageBucket: "dbiebi.appspot.com",
      messagingSenderId: "1068164821081",
      appId: "1:1068164821081:web:2d3e0030d5311d94f30148",
    };
    
    firebase.initializeApp(configuracaoFirebase);
    var bancoDeDados = firebase.firestore();

    // Obtém o ID da reunião da URL
    const urlParams = new URLSearchParams(window.location.search);
    const reuniaoId = urlParams.get('id');

    if (reuniaoId) {
      // Carrega os dados da reunião
      bancoDeDados.collection('reuniao').doc(reuniaoId).get()
        .then(doc => {
          if (doc.exists) {
            const dados = doc.data();  

            // Preenchimento dos campos
            document.getElementById('data').value = dados.data.toDate().toLocaleDateString('pt-BR');
            document.getElementById('igreja').value= dados.igreja;
            document.getElementById('supervisor').value = dados.supervisor;
            document.getElementById('lider').value = dados.lider;
            document.getElementById('celula').value = dados.celula;
            document.getElementById('reuniaoRealizada').checked = dados.reuniaoRealizada;
            document.getElementById('qtdVisitantes').value = dados.qtdVisitantes;
            document.getElementById('oferta').value = `R$ ${dados.oferta.toFixed(2)}`;
            document.getElementById('tipoAlimento').value = dados.tipoAlimento;
            document.getElementById('qtdAlimento').value = dados.qtdAlimento;
            document.getElementById('qtdMembros').value = dados.qtdMembros;
            document.getElementById('membroPresentes').value = dados.membroPresentes;


            toggleCamposReuniao(); // Atualiza a exibição do formulário
          }
        });
    }


    // Referência ao formulário
    var formulario = document.getElementById("reuniaoForm");
    var selectRedes = document.getElementById("rede");
    var selectSupervisores = document.getElementById("supervisor");
    var selectLideres = document.getElementById("lider");
    var inputCelula = document.getElementById("celula");
    var presencaContainer = document.getElementById("presencaContainer");

    // Obter o ano e mês/ano a partir da data selecionada
    var inputData = document.getElementById("data");
    var inputAno = document.getElementById("ano");
    var inputMesAno = document.getElementById("mesAno");

    // Inicializar o Flatpickr no campo de data
    flatpickr("#data", {
      dateFormat: "d/m/Y",
      locale: "pt",
      disableMobile: "true",
      placeholder: "Selecione a data...",
      allowInput: false,
      maxDate: "today",
      onChange: function (selectedDates, dateStr, instance) {
        var dataEscolhida = selectedDates[0];
        if (dataEscolhida > new Date()) {
          alert(
            "Data inválida. Por favor, selecione uma data até o dia atual."
          );
          instance.clear();
        } else {
          inputAno.value = dataEscolhida.getFullYear();
          var mes = String(dataEscolhida.getMonth() + 1).padStart(2, "0");
          var ano = dataEscolhida.getFullYear();
          inputMesAno.value = mes + "/" + ano;
        }
      },
    });

    // Formatação da oferta
    document.getElementById("oferta").addEventListener("input", function (e) {
      var value = e.target.value.replace(/\D/g, "");
      value = (value / 100).toFixed(2) + "";
      value = value.replace(".", ",");
      value = value.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
      value = value.replace(/(\d)(\d{3}),/g, "$1.$2,");
      e.target.value = "R$ " + value;
    });

   
    // Função para carregar a lista de membros com base no líder selecionado
    function carregarMembros(lider) {
      presencaContainer.innerHTML = ""; // Limpar o container primeiro
      var qtdMembrosInput = document.getElementById("qtdMembros");
      qtdMembrosInput.value = "";

      if (lider) {
        bancoDeDados
          .collection("membros")
          .where("lidercelula", "==", lider)
          .get()
          .then((querySnapshot) => {
            var membros = [];
            querySnapshot.forEach((doc) => {
              membros.push({ id: doc.id, nome: doc.data().nome });
            });

            // Ordenar os membros por nome
            membros.sort((a, b) => a.nome.localeCompare(b.nome));

            var qtdMembros = membros.length; // Usar o comprimento do array membros
            membros.forEach((membro) => {
              const div = document.createElement("div");
              div.classList.add("form-check");

              const input = document.createElement("input");
              input.type = "checkbox";
              input.classList.add("form-check-input");
              input.id = `membro-${membro.id}`;
              input.value = membro.nome;
              input.addEventListener("change", atualizarMembroPresentes);

              const label = document.createElement("label");
              label.classList.add("form-check-label");
              label.htmlFor = `membro-${membro.id}`;
              label.textContent = membro.nome;

              div.appendChild(input);
              div.appendChild(label);
              presencaContainer.appendChild(div);
            });

            qtdMembrosInput.value = qtdMembros;
          })
          .catch((error) => {
            console.error("Erro ao carregar membros:", error);
          });
      }
    }

    // Carregar lista de alimentos no dropdown
    function carregarListaAlimentos() {
      const selectAlimentos = document.getElementById("tipoAlimento");

      bancoDeDados
        .collection("listaAlimentos")
        .orderBy("nomeAlimento")
        .get()
        .then((snapshot) => {
          snapshot.forEach((doc) => {
            const option = document.createElement("option");
            option.value = doc.data().nomeAlimento;
            option.text = `${doc.data().nomeAlimento}`;
            selectAlimentos.add(option);
          });
        })
        .catch((error) => console.log("Erro ao carregar alimentos:", error));
    }

    // Add this after carregarListaAlimentos function
    document
      .getElementById("tipoAlimento")
      .addEventListener("change", function () {
        const qtdAlimentoInput = document.getElementById("qtdAlimento");
        qtdAlimentoInput.disabled = !this.value;
        if (!this.value) {
          qtdAlimentoInput.value = "";
        }
      });

    // Chamar a função após o DOM carregar
    document.addEventListener("DOMContentLoaded", carregarListaAlimentos);

    // Função para atualizar o campo Membros Presentes
    function atualizarMembroPresentes() {
      var membrosPresentesInput = document.getElementById("membroPresentes");
      var checkboxes = Array.from(
        document.querySelectorAll('input[type="checkbox"]:checked')
      ).filter((checkbox) => checkbox.id !== "reuniaoRealizada");
      membrosPresentesInput.value = checkboxes.length;
    }

    // Função para alterar a cor da caixa de acordo com a rede escolhida
    function alterarCorRede(rede) {
      var selectRede = document.getElementById("rede");
      var cores = {
        AMARELA: "#FFD700",
        AZUL: "#000080",
        TEEN: "#4B0082",
        LARANJA: "#FF8C00",
        VERMELHA: "#8B0000",
        BLACK: "#000000",
        VERDE: "#006400",
      };

      var cor = cores[rede] || "#000000";
      selectRede.style.backgroundColor = cor;
      selectRede.style.color = "#FFFFFF";
    }

    // Função para mostrar/ocultar campos com base no switch
    function toggleCamposReuniao() {
      var reuniaoRealizadaSwitch =
        document.getElementById("reuniaoRealizada");
      var camposReuniao = document.querySelectorAll(".campo-reuniao");
      var enviarBtn = document.getElementById("enviarBtn");
      var lider = document.getElementById("lider").value;

      // Apenas recarregar membros se o switch estiver marcado (reunião está acontecendo)
      if (reuniaoRealizadaSwitch.checked) {
        carregarMembros(lider);
      }

      if (reuniaoRealizadaSwitch.checked) {
        camposReuniao.forEach(function (campo) {
          campo.style.display = "block";
          // Tornar os campos visíveis obrigatórios
          var inputs = campo.querySelectorAll("input, select, textarea");
          inputs.forEach(function (input) {
            if (input.id !== "membroPresentes" && input.id !== "qtdMembros") {
              input.required = true;
            }
          });
        });
        //enviarBtn.textContent = "Enviar";
      } else {
        camposReuniao.forEach(function (campo) {
          campo.style.display = "none";
          // Remover a obrigatoriedade dos campos ocultos
          var inputs = campo.querySelectorAll("input, select, textarea");
          inputs.forEach(function (input) {
            input.required = false;
          });
        });
        // Limpar campos específicos
        document.getElementById("qtdVisitantes").value = "";
        document.getElementById("oferta").value = "";
        enviarBtn.textContent = "Confirmar Não Realização";

        // Atualizar o campo de membros presentes antes de redefinir
        atualizarMembroPresentes();
        document.getElementById("membroPresentes").value = "0";
      }
    }

    document
      .getElementById("qtdAlimento")
      .addEventListener("input", function (e) {
        this.value = Math.floor(this.value);
        if (this.value < 1) this.value = "";
      });

    // Adicionar evento de change ao switch
    document
      .getElementById("reuniaoRealizada")
      .addEventListener("change", toggleCamposReuniao);
    // Chamar a função inicialmente para garantir o estado correto
    toggleCamposReuniao();

document.getElementById('btnAtualizar').addEventListener('click', function() {
    const dataInput = document.getElementById('data').value;
    const [dia, mes, ano] = dataInput.split("/").map(Number);

    const dadosAtualizados = {
        data: firebase.firestore.Timestamp.fromDate(new Date(ano, mes - 1, dia, 21, 0, 0))
    };

    if (document.getElementById('reuniaoRealizada').checked) {
      //  dadosAtualizados.presenca = Array.from(
      //      document.querySelectorAll('input[type="checkbox"]:checked')
      //  )
      //      .filter(checkbox => checkbox.id !== 'reuniaoRealizada')
      //      .map(checkbox => checkbox.value);
        dadosAtualizados.qtdVisitantes = parseInt(document.getElementById('qtdVisitantes').value);
        dadosAtualizados.oferta = parseFloat(document.getElementById('oferta').value.replace(/[^\d,]/g, '').replace(',', '.'));
        dadosAtualizados.tipoAlimento = document.getElementById('tipoAlimento').value;
        dadosAtualizados.qtdAlimento = parseInt(document.getElementById('qtdAlimento').value);
        //dadosAtualizados.qtdMembros = parseInt(document.getElementById('qtdMembros').value);
        //dadosAtualizados.membroPresentes = parseInt(document.getElementById('membroPresentes').value);
    }

    bancoDeDados.collection('reuniao').doc(reuniaoId).update(dadosAtualizados)
        .then(() => {
            alert('Reunião atualizada com sucesso!');
            window.location.href = './Relatórios/relDadosResuniao.html';
        })
        .catch(error => {
            alert('Erro ao atualizar reunião: ' + error.message);
        });
});

document.getElementById('btnExcluir').addEventListener('click', function() {
    if (confirm('Tem certeza que deseja excluir esta reunião?')) {
        bancoDeDados.collection('reuniao').doc(reuniaoId).delete()
            .then(() => {
                alert('Reunião excluída com sucesso!');
                window.location.href = './Relatórios/relDadosResuniao.html';
            })
            .catch(error => {
                alert('Erro ao excluir reunião: ' + error.message);
            });
    }
});

  
  </script>
</body>

</html>